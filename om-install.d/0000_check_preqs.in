#!/bin/bash
function checkPreqs {
    required_tools=( ruby git ssh ssh-keygen rrdtool nmap collectd graphviz redis-server iftop pidgin mtr )
    log "Checking system for required tools & libraries...\n"
    debug "PATH is set to: $PATH\n"

    # check tools, special treatment for ruby
    missing_tools=()
    local tool
	for tool in "${required_tools[@]}"
	do
	    if [ "$tool" = "ruby" ]; then continue; fi
 		if ! which $tool > /dev/null 2>&1
 		then
    			debug "Couldn't find '$tool' in $PATH\n" >&2
    			missing_tools=("${missing_tools[@]} $tool")
    			ret=1
 		fi
	done

	# TODO ruby command may be provided by PATH or .rvm
    if ! which ruby > /dev/null 2>&1 ; then
        debug "Couldn't find 'ruby' in $PATH\n" >&2 ;
        missing_tools=("${missing_tools[@]} ruby")
        ret=1;
    fi
    #if [ -d "${HOME}/.rvm" ] ; then
    #    rvm_pathes=(`find "${HOME}/.rvm/rubies/" -maxdepth 2 -type d -name 'bin'`)
	#    debug "Found RVM pathes: ${rvm_pathes[@]}"
    #fi

	# some tools are missing
	if [ $ret = 1 ] ; then
	    #echo "Missing tools: ${missing_tools[@]}"
		log-red "Whoops! This system lacks software needed to run Openmetrics.\n"
		while true; do
		    read -p "I'll try to fix this for you. Ok? [$dialogInstallPreqs]: "; evalYesNo dialogInstallPreqs
        done
        return 1
	fi

	# prerequisites check succeeded
	return 0
}
